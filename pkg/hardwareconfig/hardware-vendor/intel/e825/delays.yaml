# Delay Compensation Model for Intel E825 (GNR-D)
# This file defines the three-layer model: Topology (components), Physics (connections), and Intent (routes)

# 1. Inventory - static phase transfer nodes
components:
  - id: "NAC0 PTP phase output"
    description: "Network adapter card PTP phase output"
  - id: "NAC0 PTP phase input"
    description: "Network adapter card PTP phase input"

  - id: "DPLL 1kHz input"
    description: "DPLL phase reference input from NAC0, Frequency - 1kHz"
    compensationPoint:
      name: "GNR-D_SDP2"  # Board label matching pinDefaults
      type: dpll
  - id: "DPLL 1kHz phase output"
    description: "DPLL phase signal output to NAC0, Frequency - 1kHz"
    compensationPoint:
      name: "GNR_D_SDP3"  # Board label matching pinDefaults
      type: dpll
  - id: "DPLL ePPS output 1"
    description: "DPLL enhanced PPS output pin to CF1"
    compensationPoint:
      name: "OCP1_CLK"  # Board label matching pinDefaults
      type: dpll
  - id: "DPLL ePPS output 2"
    description: "DPLL enhanced PPS output pin to CF2"
    compensationPoint:
      name: "OCP2_CLK"  # Board label matching pinDefaults
      type: dpll
  - id: "CF1 ePPS input"
    description: "CF1 enhanced PPS input from DPLL"
  - id: "CF2 ePPS input"
    description: "CF2 enhanced PPS input from DPLL"
  
# 2. Topology: Physical connections (graph edges)
# Each connection defines a delay segment in the signal path
connections:
  # NAC to Timing Module routing/wiring
  - from: "NAC0 PTP phase output"
    to: "DPLL 1kHz input"
    description: "Routing delay from NAC to DPLL 1kHz input"
    # When provided by the platform, this specifies how to get the delay from sysfs
    # getter:
    #   FSRead:
    #     path: "/sys/class/net/{interface}/device/ptp/ptp*/delay/nac_to_timing_module"
    # Pre-coded fallback default for when platform doesn't provide it
    delayPs: 2500
  # DPLL to NAC (during holdover)
  - from: "DPLL 1kHz phase output"
    to: "NAC0 PTP phase input"
    description: "Routing delay from DPLL 1kHz phase output to NAC0 PTP phase input"
    delayPs: 2500
  # Timing module internal routing from DPLL output pin to connector output pin
  # We skip the MUX delay and factor everything in
  - from: "DPLL ePPS output 1"
    to: "CF1 ePPS input"
    description: "Internal routing delay from DPLL output 1 to CF1 input"
    delayPs: 2500
  - from: "DPLL ePPS output 2"
    to: "CF2 ePPS input"
    description: "Internal routing delay from DPLL output 2 to CF2 input"
    delayPs: 2500
  


# 3. Logic: Where do we compensate for the delay
# Routes define compensation strategies for specific signal paths
routes:
  # Input side compensation: NAC PTP to DPLL input
  - name: "NAC PTP to DPLL"
    description: "Compensate for delays from NAC PTP output to DPLL input"
    sequence:
      - "NAC0 PTP phase output"
      - "DPLL 1kHz input"
    compensator: "DPLL 1kHz input"
  - name: "DPLL to NAC"
    description: "Compensate for delays from DPLL to NAC"
    sequence:
      - "DPLL 1kHz phase output"
      - "NAC0 PTP phase input"
    compensator: "DPLL 1kHz phase output"
  
  # Output side compensation: DPLL to Carter Flats (unmanaged inputs)
  - name: "DPLL to CF1"
    description: "Compensate for delays from DPLL output to Carter Flats input"
    sequence:
      - "DPLL ePPS output 1"
      - "CF1 ePPS input"
    compensator: "DPLL ePPS output 1"

  - name: "DPLL to CF2"
    description: "Compensate for delays from DPLL output to Carter Flats input"
    sequence:
      - "DPLL ePPS output 2"
      - "CF2 ePPS input"
    compensator: "DPLL ePPS output 2"